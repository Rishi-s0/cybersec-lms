import React, { useState } from 'react';
import { Bug, Play, Globe, Shield, AlertTriangle, CheckCircle, Info, Clock } from 'lucide-react';

const VulnerabilityScanner = ({ onClose }) => {
  const [targetUrl, setTargetUrl] = useState('');
  const [scanType, setScanType] = useState('basic');
  const [isScanning, setIsScanning] = useState(false);
  const [scanResults, setScanResults] = useState(null);
  const [progress, setProgress] = useState(0);

  const scanTypes = {
    basic: {
      name: 'Basic Scan',
      description: 'Quick security headers and basic vulnerability check',
      checks: ['Security Headers', 'SSL/TLS', 'Server Information', 'Common Ports']
    },
    owasp: {
      name: 'OWASP Top 10',
      description: 'Scan for OWASP Top 10 vulnerabilities',
      checks: ['Injection', 'Broken Auth', 'Sensitive Data', 'XXE', 'Broken Access', 'Security Config', 'XSS', 'Insecure Deserialization', 'Known Vulnerabilities', 'Insufficient Logging']
    },
    comprehensive: {
      name: 'Comprehensive',
      description: 'Full security assessment including all checks',
      checks: ['All Basic Checks', 'OWASP Top 10', 'Directory Traversal', 'File Upload', 'CSRF', 'Clickjacking']
    }
  };

  const vulnerabilityDatabase = {
    'missing-security-headers': {
      name: 'Missing Security Headers',
      severity: 'Medium',
      description: 'Important security headers are missing',
      impact: 'May allow XSS, clickjacking, or other attacks',
      recommendation: 'Implement Content-Security-Policy, X-Frame-Options, X-Content-Type-Options headers'
    },
    'weak-ssl': {
      name: 'Weak SSL/TLS Configuration',
      severity: 'High',
      description: 'SSL/TLS configuration has weaknesses',
      impact: 'Man-in-the-middle attacks, data interception',
      recommendation: 'Use TLS 1.2+, strong cipher suites, proper certificate validation'
    },
    'server-disclosure': {
      name: 'Server Information Disclosure',
      severity: 'Low',
      description: 'Server reveals version information',
      impact: 'Information gathering for targeted attacks',
      recommendation: 'Hide server version in HTTP headers'
    },
    'directory-listing': {
      name: 'Directory Listing Enabled',
      severity: 'Medium',
      description: 'Web server allows directory browsing',
      impact: 'Information disclosure, file enumeration',
      recommendation: 'Disable directory listing in web server configuration'
    },
    'default-credentials': {
      name: 'Default Credentials',
      severity: 'Critical',
      description: 'Default or weak credentials detected',
      impact: 'Unauthorized access to system',
      recommendation: 'Change all default passwords, implement strong authentication'
    },
    'sql-injection': {
      name: 'SQL Injection Vulnerability',
      severity: 'Critical',
      description: 'Application vulnerable to SQL injection',
      impact: 'Database compromise, data theft',
      recommendation: 'Use parameterized queries, input validation'
    },
    'xss-vulnerability': {
      name: 'Cross-Site Scripting (XSS)',
      severity: 'High',
      description: 'Application vulnerable to XSS attacks',
      impact: 'Session hijacking, malicious script execution',
      recommendation: 'Input sanitization, output encoding, CSP headers'
    },
    'csrf-vulnerability': {
      name: 'Cross-Site Request Forgery (CSRF)',
      severity: 'Medium',
      description: 'Application lacks CSRF protection',
      impact: 'Unauthorized actions on behalf of users',
      recommendation: 'Implement CSRF tokens, SameSite cookies'
    },
    'insecure-file-upload': {
      name: 'Insecure File Upload',
      severity: 'High',
      description: 'File upload functionality lacks proper validation',
      impact: 'Remote code execution, malware upload',
      recommendation: 'Validate file types, scan uploads, restrict execution'
    },
    'weak-authentication': {
      name: 'Weak Authentication',
      severity: 'High',
      description: 'Authentication mechanism has weaknesses',
      impact: 'Account takeover, unauthorized access',
      recommendation: 'Implement MFA, strong password policies, account lockout'
    }
  };

  const simulateScan = async () => {
    if (!targetUrl.trim()) {
      setScanResults({ error: 'Please enter a target URL' });
      return;
    }

    // Basic URL validation
    try {
      new URL(targetUrl);
    } catch {
      setScanResults({ error: 'Please enter a valid URL (include http:// or https://)' });
      return;
    }

    setIsScanning(true);
    setProgress(0);
    setScanResults(null);

    const totalChecks = scanTypes[scanType].checks.length;
    const vulnerabilities = [];
    const passedChecks = [];

    // Simulate scanning process
    for (let i = 0; i < totalChecks; i++) {
      await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1200));
      setProgress(((i + 1) / totalChecks) * 100);

      const checkName = scanTypes[scanType].checks[i];
      
      // Simulate vulnerability detection (random for demo)
      const shouldFindVuln = Math.random() < 0.3; // 30% chance of finding vulnerability
      
      if (shouldFindVuln) {
        const vulnKeys = Object.keys(vulnerabilityDatabase);
        const randomVuln = vulnKeys[Math.floor(Math.random() * vulnKeys.length)];
        const vuln = vulnerabilityDatabase[randomVuln];
        
        vulnerabilities.push({
          id: randomVuln,
          check: checkName,
          ...vuln,
          foundAt: new Date().toISOString()
        });
      } else {
        passedChecks.push({
          check: checkName,
          status: 'Passed',
          description: `${checkName} check completed successfully`
        });
      }
    }

    // Calculate risk score
    const criticalCount = vulnerabilities.filter(v => v.severity === 'Critical').length;
    const highCount = vulnerabilities.filter(v => v.severity === 'High').length;
    const mediumCount = vulnerabilities.filter(v => v.severity === 'Medium').length;
    const lowCount = vulnerabilities.filter(v => v.severity === 'Low').length;

    const riskScore = (criticalCount * 10) + (highCount * 7) + (mediumCount * 4) + (lowCount * 1);
    let riskLevel = 'Low';
    if (riskScore >= 20) riskLevel = 'Critical';
    else if (riskScore >= 15) riskLevel = 'High';
    else if (riskScore >= 8) riskLevel = 'Medium';

    setScanResults({
      targetUrl,
      scanType: scanTypes[scanType].name,
      vulnerabilities,
      passedChecks,
      summary: {
        total: vulnerabilities.length,
        critical: criticalCount,
        high: highCount,
        medium: mediumCount,
        low: lowCount,
        riskScore,
        riskLevel
      },
      scanTime: new Date().toISOString(),
      duration: `${totalChecks * 1.2}s`
    });

    setIsScanning(false);
  };

  const getSeverityColor = (severity) => {
    switch (severity) {
      case 'Critical': return 'text-htb-red bg-htb-red/10 border-htb-red/30';
      case 'High': return 'text-htb-orange bg-htb-orange/10 border-htb-orange/30';
      case 'Medium': return 'text-htb-yellow bg-htb-yellow/10 border-htb-yellow/30';
      case 'Low': return 'text-htb-blue bg-htb-blue/10 border-htb-blue/30';
      default: return 'text-htb-gray bg-htb-gray/10 border-htb-gray/30';
    }
  };

  const getRiskLevelColor = (level) => {
    switch (level) {
      case 'Critical': return 'text-htb-red';
      case 'High': return 'text-htb-orange';
      case 'Medium': return 'text-htb-yellow';
      case 'Low': return 'text-htb-green';
      default: return 'text-htb-gray';
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="htb-card rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
        <div className="p-6">
          {/* Header */}
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center space-x-3">
              <Bug className="h-8 w-8 text-htb-green" />
              <div>
                <h2 className="text-2xl font-bold text-htb-gray-light">Vulnerability Scanner</h2>
                <p className="text-htb-gray">Simulate security vulnerability scanning and assessment</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="text-htb-gray hover:text-htb-red transition-colors"
            >
              âœ•
            </button>
          </div>

          {/* Scan Configuration */}
          <div className="grid md:grid-cols-3 gap-4 mb-6">
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-htb-gray-light mb-2">
                Target URL
              </label>
              <div className="relative">
                <Globe className="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-htb-gray" />
                <input
                  type="url"
                  value={targetUrl}
                  onChange={(e) => setTargetUrl(e.target.value)}
                  placeholder="https://example.com"
                  className="htb-input w-full pl-10 pr-4 py-2 rounded-lg"
                  disabled={isScanning}
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-htb-gray-light mb-2">
                Scan Type
              </label>
              <select
                value={scanType}
                onChange={(e) => setScanType(e.target.value)}
                className="htb-input w-full p-2 rounded-lg"
                disabled={isScanning}
              >
                {Object.entries(scanTypes).map(([key, type]) => (
                  <option key={key} value={key}>
                    {type.name}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {/* Scan Type Description */}
          <div className="bg-htb-blue/10 border border-htb-blue/30 p-4 rounded-lg mb-6">
            <div className="flex items-start space-x-2">
              <Info className="h-5 w-5 text-htb-blue mt-0.5" />
              <div className="text-sm text-htb-blue">
                <p className="font-medium mb-1">{scanTypes[scanType].name}</p>
                <p className="opacity-90 mb-2">{scanTypes[scanType].description}</p>
                <div className="flex flex-wrap gap-1">
                  {scanTypes[scanType].checks.map((check, index) => (
                    <span key={index} className="px-2 py-1 bg-htb-blue/20 text-htb-blue text-xs rounded">
                      {check}
                    </span>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* Scan Button */}
          <div className="mb-6">
            <button
              onClick={simulateScan}
              disabled={isScanning}
              className="htb-btn-primary px-6 py-3 rounded-lg flex items-center space-x-2"
            >
              {isScanning ? (
                <>
                  <Clock className="h-5 w-5 animate-spin" />
                  <span>Scanning... {progress.toFixed(0)}%</span>
                </>
              ) : (
                <>
                  <Play className="h-5 w-5" />
                  <span>Start Vulnerability Scan</span>
                </>
              )}
            </button>
          </div>

          {/* Progress Bar */}
          {isScanning && (
            <div className="mb-6">
              <div className="w-full bg-htb-dark-light rounded-full h-3">
                <div
                  className="bg-htb-green h-3 rounded-full transition-all duration-300"
                  style={{ width: `${progress}%` }}
                ></div>
              </div>
            </div>
          )}

          {/* Scan Results */}
          {scanResults && (
            <div className="space-y-6">
              {scanResults.error ? (
                <div className="bg-htb-red/10 border border-htb-red/30 p-4 rounded-lg">
                  <div className="flex items-center space-x-2">
                    <AlertTriangle className="h-5 w-5 text-htb-red" />
                    <span className="text-htb-red font-medium">{scanResults.error}</span>
                  </div>
                </div>
              ) : (
                <>
                  {/* Scan Summary */}
                  <div className="bg-htb-dark-light p-6 rounded-lg">
                    <h3 className="text-xl font-bold text-htb-gray-light mb-4">Scan Summary</h3>
                    <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <div className="text-center">
                        <div className="text-2xl font-bold text-htb-red">{scanResults.summary.critical}</div>
                        <div className="text-sm text-htb-gray">Critical</div>
                      </div>
                      <div className="text-center">
                        <div className="text-2xl font-bold text-htb-orange">{scanResults.summary.high}</div>
                        <div className="text-sm text-htb-gray">High</div>
                      </div>
                      <div className="text-center">
                        <div className="text-2xl font-bold text-htb-yellow">{scanResults.summary.medium}</div>
                        <div className="text-sm text-htb-gray">Medium</div>
                      </div>
                      <div className="text-center">
                        <div className="text-2xl font-bold text-htb-blue">{scanResults.summary.low}</div>
                        <div className="text-sm text-htb-gray">Low</div>
                      </div>
                    </div>
                    <div className="mt-4 text-center">
                      <div className="text-sm text-htb-gray mb-1">Overall Risk Level</div>
                      <div className={`text-xl font-bold ${getRiskLevelColor(scanResults.summary.riskLevel)}`}>
                        {scanResults.summary.riskLevel} (Score: {scanResults.summary.riskScore})
                      </div>
                    </div>
                  </div>

                  {/* Vulnerabilities */}
                  {scanResults.vulnerabilities.length > 0 && (
                    <div>
                      <h3 className="text-xl font-bold text-htb-gray-light mb-4">Vulnerabilities Found</h3>
                      <div className="space-y-4">
                        {scanResults.vulnerabilities.map((vuln, index) => (
                          <div key={index} className={`p-4 rounded-lg border ${getSeverityColor(vuln.severity)}`}>
                            <div className="flex items-start justify-between mb-2">
                              <h4 className="font-semibold">{vuln.name}</h4>
                              <span className="px-2 py-1 rounded text-xs font-medium">
                                {vuln.severity}
                              </span>
                            </div>
                            <p className="text-sm opacity-90 mb-2">{vuln.description}</p>
                            <div className="text-xs opacity-75 space-y-1">
                              <p><strong>Impact:</strong> {vuln.impact}</p>
                              <p><strong>Recommendation:</strong> {vuln.recommendation}</p>
                              <p><strong>Found in:</strong> {vuln.check}</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Passed Checks */}
                  {scanResults.passedChecks.length > 0 && (
                    <div>
                      <h3 className="text-xl font-bold text-htb-gray-light mb-4">Passed Security Checks</h3>
                      <div className="grid md:grid-cols-2 gap-3">
                        {scanResults.passedChecks.map((check, index) => (
                          <div key={index} className="bg-htb-green/10 border border-htb-green/30 p-3 rounded-lg">
                            <div className="flex items-center space-x-2">
                              <CheckCircle className="h-4 w-4 text-htb-green" />
                              <span className="text-sm font-medium text-htb-green">{check.check}</span>
                            </div>
                            <p className="text-xs text-htb-green opacity-75 mt-1">{check.description}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Scan Details */}
                  <div className="bg-htb-dark-light p-4 rounded-lg">
                    <h4 className="font-semibold text-htb-gray-light mb-2">Scan Details</h4>
                    <div className="grid md:grid-cols-2 gap-4 text-sm text-htb-gray">
                      <div>Target: {scanResults.targetUrl}</div>
                      <div>Scan Type: {scanResults.scanType}</div>
                      <div>Duration: {scanResults.duration}</div>
                      <div>Completed: {new Date(scanResults.scanTime).toLocaleString()}</div>
                    </div>
                  </div>
                </>
              )}
            </div>
          )}

          {/* Educational Warning */}
          <div className="mt-6 bg-htb-red/10 border border-htb-red/30 p-4 rounded-lg">
            <div className="flex items-start space-x-2">
              <AlertTriangle className="h-5 w-5 text-htb-red mt-0.5" />
              <div className="text-sm text-htb-red">
                <p className="font-medium mb-1">Educational Simulation Only</p>
                <p className="text-xs opacity-90">
                  This is a simulated vulnerability scanner for educational purposes. 
                  Only scan systems you own or have explicit permission to test. 
                  Real vulnerability scanning without permission is illegal.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityScanner;